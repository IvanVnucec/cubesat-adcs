<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="69,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T4U3">qib</span>, <span class="var type1" id="S3T3U4">NOI</span>] = q_gd(<span class="var type1" id="S4T2U7">a_b</span>, <span class="var type1" id="S5T2U8">m_b</span>, <span class="var type1" id="S6T2U9">a_i</span>, <span class="var type1" id="S7T2U10">m_i</span>, <span class="var type1 sgl" id="S2T4U11">qib</span>, <span class="var type1" id="S8T3U12">alpha</span>, <span class="var type1" id="S9T3U13">N_max</span>, <span class="var type1" id="S10T3U14">dJ_max</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="69,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">% Funkcija q_gd() je iterativni estimator kvaterniona koja prima:</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">%       a_b = mjereni vektor akceleracije u koordinatnom sustavu tijela</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">%       m_b = mjereni vektor magnetskog polja u koordinatnom sustavu tijela     </span></span></span>
<span class="srcline"><span class="lineno"><a href="69,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">%       a_i = mjereni vektor akceleracije u inercijalnom koordinatnom sustavu</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">%       m_i = mjereni vektor akceleracije u inercijalnom koordinatnom sustavu</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,7" id="srcline7"> 7</a></span><span class="line"><span class="comment">%       qib = inicijalni kvaternion za početak iteratovnog postupa te maksimalnu</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,8" id="srcline8"> 8</a></span><span class="line"><span class="comment">%       N_max = maksimalni broj iteracija</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">%       dJ_max = dozvoljenu razliku u gresci</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,10" id="srcline10">10</a></span><span class="line"><span class="comment">% Funkcija q_gd() vraca vektor koji sadrzi dva elementa:</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,11" id="srcline11">11</a></span><span class="line"><span class="comment">%       qib = estimirani kvaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,12" id="srcline12">12</a></span><span class="line"><span class="comment">%       NOI = broj izvršenih itreracija</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,13" id="srcline13">13</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="69,14" id="srcline14">14</a></span><span class="line"><span class="mxinfo  sgl" id="T2:U11"><span class="var type1" id="S6T2U17">a_i</span> = <span class="mxinfo  sgl" id="T2:U13"><span class="var type1" id="S6T2U19">a_i</span>/<span class="mxinfo  sgl" id="T3:U15">norm(<span class="var type1" id="S6T2U22">a_i</span>)</span></span></span>;    <span class="comment">% Normaliziram akceleraciju</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,15" id="srcline15">15</a></span><span class="line"><span class="mxinfo  sgl" id="T2:U17"><span class="var type1" id="S7T2U25">m_i</span> = <span class="mxinfo  sgl" id="T2:U19"><span class="var type1" id="S7T2U27">m_i</span>/<span class="mxinfo  sgl" id="T3:U21">norm(<span class="var type1" id="S7T2U30">m_i</span>)</span></span></span>;    <span class="comment">% Normaliziram mag polje</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,16" id="srcline16">16</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="69,17" id="srcline17">17</a></span><span class="line"><span class="mxinfo  sgl" id="T2:U23"><span class="var type1" id="S4T2U33">a_b</span> = <span class="mxinfo  sgl" id="T2:U25"><span class="var type1" id="S4T2U35">a_b</span>/<span class="mxinfo  sgl" id="T3:U27">norm(<span class="var type1" id="S4T2U38">a_b</span>)</span></span></span>;    <span class="comment">% Normaliziram akceleraciju</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,18" id="srcline18">18</a></span><span class="line"><span class="mxinfo  sgl" id="T2:U29"><span class="var type1" id="S5T2U41">m_b</span> = <span class="mxinfo  sgl" id="T2:U31"><span class="var type1" id="S5T2U43">m_b</span>/<span class="mxinfo  sgl" id="T3:U33">norm(<span class="var type1" id="S5T2U46">m_b</span>)</span></span></span>;    <span class="comment">% Normaliziram mag polje</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,19" id="srcline19">19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="69,20" id="srcline20">20</a></span><span class="line"><span class="mxinfo  sgl" id="T3:U35"><span class="var type1 sgl" id="S12T3U49">J_previous</span> = <span class="mxinfo  sgl" id="T3:U37">0</span></span>;         <span class="comment">% Prethodna vrijednost funkcije cilja (geldamo razliku)</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo " id="T3:U38"><span class="var type1" id="S3T3U53">NOI</span> = <span class="mxinfo " id="T3:U40">0</span></span>;                <span class="comment">% Trenutni broj iteracija</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,22" id="srcline22">22</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="69,23" id="srcline23">23</a></span><span class="line"><span class="comment">% Pokrecem petlju s maksimalno N_max iteracija</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,24" id="srcline24">24</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S13T3U57">i</span>=<span class="mxinfo " id="T3:U42"><span class="mxinfo " id="T3:U43">1</span>:<span class="var type1" id="S9T3U60">N_max</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="69,25" id="srcline25">25</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="69,26" id="srcline26">26</a></span><span class="line">    <span class="comment">% Racunam rotacijsku matricu</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,27" id="srcline27">27</a></span><span class="line">    <span class="mxinfo  sgl" id="T27:U45"><span class="var type1" id="S14T27U63">Rib</span> = <span class="mxinfo  sgl" id="T27:U47"><span class="fcn" id="F214N7:B65">qib2Rib</span>(<span class="var type1 sgl" id="S2T4U66">qib</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,28" id="srcline28">28</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="69,29" id="srcline29">29</a></span><span class="line">    <span class="comment">% Racunam vektora greske</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,30" id="srcline30">30</a></span><span class="line">    <span class="mxinfo  sgl" id="T2:U49"><span class="var type1" id="S16T2U69">e_a</span> = <span class="mxinfo  sgl" id="T2:U51"><span class="mxinfo  sgl" id="T2:U52"><span class="var type1 sgl" id="S14T27U72">Rib</span>*<span class="var type1 sgl" id="S6T2U73">a_i</span></span> - <span class="var type1 sgl" id="S4T2U74">a_b</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,31" id="srcline31">31</a></span><span class="line">    <span class="mxinfo  sgl" id="T2:U56"><span class="var type1" id="S17T2U77">e_m</span> = <span class="mxinfo  sgl" id="T2:U58"><span class="mxinfo  sgl" id="T2:U59"><span class="var type1 sgl" id="S14T27U80">Rib</span>*<span class="var type1 sgl" id="S7T2U81">m_i</span></span> - <span class="var type1 sgl" id="S5T2U82">m_b</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,32" id="srcline32">32</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="69,33" id="srcline33">33</a></span><span class="line">    <span class="comment">% Racunam vrijednost funckije cilja u i-toj iteraciji</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,34" id="srcline34">34</a></span><span class="line">    <span class="mxinfo " id="T3:U63"><span class="var type1" id="S18T3U85">J_a</span> = <span class="mxinfo  sgl" id="T3:U65"><span class="mxinfo " id="T28:U66"><span class="var type1 sgl" id="S16T2U88">e_a</span>'</span>*<span class="var type1 sgl" id="S16T2U89">e_a</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,35" id="srcline35">35</a></span><span class="line">    <span class="mxinfo " id="T3:U69"><span class="var type1" id="S19T3U92">J_m</span> = <span class="mxinfo  sgl" id="T3:U71"><span class="mxinfo " id="T28:U72"><span class="var type1 sgl" id="S17T2U95">e_m</span>'</span>*<span class="var type1 sgl" id="S17T2U96">e_m</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,36" id="srcline36">36</a></span><span class="line">    <span class="mxinfo  sgl" id="T3:U75"><span class="var type1" id="S20T3U99">J_current</span> = <span class="mxinfo  sgl" id="T3:U77"><span class="var type1" id="S18T3U101">J_a</span> + <span class="var type1" id="S19T3U102">J_m</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,37" id="srcline37">37</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="69,38" id="srcline38">38</a></span><span class="line">    <span class="comment">% Provjeravam je li ispunjen uvjet za prekid iterativnog postupka</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,39" id="srcline39">39</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T5:U80"><span class="mxinfo  sgl" id="T3:U81">abs(<span class="mxinfo  sgl" id="T3:U82"><span class="var type1 sgl" id="S20T3U109">J_current</span> - <span class="var type1 sgl" id="S12T3U110">J_previous</span></span>)</span> &lt; <span class="var type1" id="S10T3U111">dJ_max</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="69,40" id="srcline40">40</a></span><span class="line">        <span class="keyword">break</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,41" id="srcline41">41</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,42" id="srcline42">42</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="69,43" id="srcline43">43</a></span><span class="line">    <span class="comment">% Racunam gradijent funkcije cilja za trenutni kvaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,44" id="srcline44">44</a></span><span class="line">    <span class="mxinfo  sgl" id="T4:U86"><span class="var type1" id="S22T4U115">grad_J</span> = <span class="mxinfo  sgl" id="T4:U88"><span class="fcn" id="F281N4:B117">grad</span>(<span class="var type1 sgl" id="S6T2U118">a_i</span>, <span class="var type1 sgl" id="S7T2U119">m_i</span>, <span class="var type1 sgl" id="S16T2U120">e_a</span>, <span class="var type1 sgl" id="S17T2U121">e_m</span>, <span class="var type1 sgl" id="S2T4U122">qib</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,45" id="srcline45">45</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="69,46" id="srcline46">46</a></span><span class="line">    <span class="comment">% Primijenjujem gradient decent algoritam na svaki element kvaterniona</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,47" id="srcline47">47</a></span><span class="line">    <span class="mxinfo  sgl" id="T4:U94"><span class="var type1" id="S2T4U125">qib</span> = <span class="mxinfo  sgl" id="T4:U96"><span class="var type1 sgl" id="S2T4U127">qib</span> - <span class="mxinfo  sgl" id="T4:U98"><span class="var type1" id="S8T3U129">alpha</span>*<span class="var type1 sgl" id="S22T4U130">grad_J</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,48" id="srcline48">48</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="69,49" id="srcline49">49</a></span><span class="line">    <span class="comment">% Normaliziram izračunati kvaternion</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,50" id="srcline50">50</a></span><span class="line">    <span class="mxinfo  sgl" id="T4:U101"><span class="var type1" id="S2T4U133">qib</span> = <span class="mxinfo  sgl" id="T4:U103"><span class="var type1 sgl" id="S2T4U135">qib</span>/<span class="mxinfo  sgl" id="T3:U105">norm(<span class="var type1 sgl" id="S2T4U138">qib</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,51" id="srcline51">51</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="69,52" id="srcline52">52</a></span><span class="line">    <span class="comment">% Pripremam vrijednost cost funkcije za sljedecu iteraciju</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,53" id="srcline53">53</a></span><span class="line">    <span class="mxinfo  sgl" id="T3:U107"><span class="var type1 sgl" id="S12T3U141">J_previous</span> = <span class="var type1 sgl" id="S20T3U142">J_current</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,54" id="srcline54">54</a></span><span class="line">    <span class="mxinfo " id="T3:U110"><span class="var type1" id="S3T3U145">NOI</span> = <span class="mxinfo " id="T3:U112"><span class="var type1" id="S3T3U147">NOI</span> + 1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="69,55" id="srcline55">55</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="69,56" id="srcline56">56</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,57" id="srcline57">57</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="69,58" id="srcline58">58</a></span><span class="line"></span></span>
</pre>
