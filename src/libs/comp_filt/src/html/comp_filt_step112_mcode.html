<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="49,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S2T4U3">qib_est</span> ] = comp_filt_step( <span class="var type1" id="S3T1U6">s</span>, <span class="var type1" id="S4T2U7">acc_b</span>, <span class="var type1" id="S5T2U8">mag_b</span>, <span class="var type1" id="S6T2U9">gyr_b</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="49,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">%COMP_FILT_STEP Summary of this function goes here</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">%   Detailed explanation goes here</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,4" id="srcline4"> 4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="49,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">% Normalize measurements</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,6" id="srcline6"> 6</a></span><span class="line"><span class="mxinfo  sgl" id="T2:U6"><span class="var type1" id="S4T2U12">acc_b</span> = <span class="mxinfo  sgl" id="T2:U8"><span class="var type1 sgl" id="S4T2U14">acc_b</span> / <span class="mxinfo  sgl" id="T3:U10">norm(<span class="var type1 sgl" id="S4T2U17">acc_b</span>)</span></span></span>;                <span class="comment">% normalized column vector in NED</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,7" id="srcline7"> 7</a></span><span class="line"><span class="mxinfo  sgl" id="T2:U12"><span class="var type1" id="S5T2U20">mag_b</span> = <span class="mxinfo  sgl" id="T2:U14"><span class="var type1 sgl" id="S5T2U22">mag_b</span> / <span class="mxinfo  sgl" id="T3:U16">norm(<span class="var type1 sgl" id="S5T2U25">mag_b</span>)</span></span></span>;                <span class="comment">% normalized row vector in NED</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,8" id="srcline8"> 8</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="49,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">% Izracunavam kvaternion iz ziroskopa</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,10" id="srcline10">10</a></span><span class="line"><span class="mxinfo  sgl" id="T4:U18"><span class="var type1" id="S8T4U28">qib_gyro</span> = <span class="mxinfo  sgl" id="T4:U20"><span class="fcn" id="F176N6:B30">q_gyro</span>(<span class="var type1 sgl" id="S6T2U31">gyr_b</span>, <span class="mxinfo  sgl" id="T4:U22"><span class="var type1 sgl" id="S3T1U33">s</span>.qib_prev</span>, <span class="mxinfo  sgl" id="T3:U24"><span class="var type1 sgl" id="S3T1U36">s</span>.dt</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="49,11" id="srcline11">11</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="49,12" id="srcline12">12</a></span><span class="line"><span class="comment">% Racunam optimalni kvaternon iz acc i mag pomocu gradient descenta</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,13" id="srcline13">13</a></span><span class="line"><span class="comment">% Za inicijalni kvaternion koristim onaj izracunat iz ziroskopa</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,14" id="srcline14">14</a></span><span class="line">[<span class="var type1 sgl" id="S10T4U41">qib_gd</span>, <span class="mxinfo " id="T3:U27">~</span>] = <span class="fcn" id="F286N5:B44">q_gd</span>(<span class="var type1 sgl" id="S4T2U45">acc_b</span>, <span class="var type1 sgl" id="S5T2U46">mag_b</span>, <span class="mxinfo  sgl" id="T2:U30"><span class="var type1 sgl" id="S3T1U48">s</span>.acc_i</span>, <span class="mxinfo  sgl" id="T2:U32"><span class="var type1 sgl" id="S3T1U51">s</span>.mag_i</span>, <span class="var type1" id="S8T4U53">qib_gyro</span>, <span class="mxinfo  sgl" id="T3:U35"><span class="var type1 sgl" id="S3T1U55">s</span>.alpha</span>, <span class="mxinfo  sgl" id="T3:U37"><span class="var type1 sgl" id="S3T1U58">s</span>.N_max</span>, <span class="mxinfo  sgl" id="T3:U39"><span class="var type1 sgl" id="S3T1U61">s</span>.dJ_max</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="49,15" id="srcline15">15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="49,16" id="srcline16">16</a></span><span class="line"><span class="comment">% Komplementarni filtar</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,17" id="srcline17">17</a></span><span class="line"><span class="mxinfo  sgl" id="T4:U41"><span class="var type1" id="S2T4U65">qib_est</span> = <span class="mxinfo  sgl" id="T4:U43"><span class="mxinfo  sgl" id="T4:U44"><span class="mxinfo  sgl" id="T3:U45"><span class="var type1 sgl" id="S3T1U69">s</span>.K_cf</span> * <span class="var type1 sgl" id="S8T4U71">qib_gyro</span></span> + <span class="mxinfo  sgl" id="T4:U48">(<span class="mxinfo  sgl" id="T3:U49">1 - <span class="mxinfo  sgl" id="T3:U50"><span class="var type1 sgl" id="S3T1U77">s</span>.K_cf</span></span>) * <span class="var type1" id="S10T4U79">qib_gd</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="49,18" id="srcline18">18</a></span><span class="line"><span class="mxinfo  sgl" id="T4:U53"><span class="var type1" id="S2T4U82">qib_est</span> = <span class="mxinfo  sgl" id="T4:U55"><span class="var type1 sgl" id="S2T4U84">qib_est</span> / <span class="mxinfo  sgl" id="T3:U57">norm(<span class="var type1 sgl" id="S2T4U87">qib_est</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="49,19" id="srcline19">19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="49,20" id="srcline20">20</a></span><span class="line"><span class="comment">% Storing current quaternion for the next iterative process</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo " id="T4:U59"><span class="mxinfo " id="T4:U60"><span class="var type1" id="S3T1U91">s</span>.qib_prev</span> = <span class="var type1" id="S2T4U93">qib_est</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="49,22" id="srcline22">22</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="49,23" id="srcline23">23</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
