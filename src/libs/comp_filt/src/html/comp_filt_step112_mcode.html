<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="49,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type1" id="S2T1U3">s</span>, <span class="var type1" id="S3T4U4">qib_est</span> ] = comp_filt_step( <span class="var type1" id="S2T1U7">s</span>, <span class="var type1" id="S4T2U8">acc_b</span>, <span class="var type1" id="S5T2U9">mag_b</span>, <span class="var type1" id="S6T2U10">gyr_b</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="49,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">%COMP_FILT_STEP Summary of this function goes here</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">%   Detailed explanation goes here</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,4" id="srcline4"> 4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="49,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">% Normalize measurements</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,6" id="srcline6"> 6</a></span><span class="line"><span class="mxinfo  sgl" id="T2:U7"><span class="var type1" id="S4T2U13">acc_b</span> = <span class="mxinfo  sgl" id="T2:U9"><span class="var type1 sgl" id="S4T2U15">acc_b</span> / <span class="mxinfo  sgl" id="T3:U11">norm(<span class="var type1 sgl" id="S4T2U18">acc_b</span>)</span></span></span>;                <span class="comment">% normalized column vector in NED</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,7" id="srcline7"> 7</a></span><span class="line"><span class="mxinfo  sgl" id="T2:U13"><span class="var type1" id="S5T2U21">mag_b</span> = <span class="mxinfo  sgl" id="T2:U15"><span class="var type1 sgl" id="S5T2U23">mag_b</span> / <span class="mxinfo  sgl" id="T3:U17">norm(<span class="var type1 sgl" id="S5T2U26">mag_b</span>)</span></span></span>;                <span class="comment">% normalized row vector in NED</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,8" id="srcline8"> 8</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="49,9" id="srcline9"> 9</a></span><span class="line"><span class="comment">% Izracunavam kvaternion iz ziroskopa</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,10" id="srcline10">10</a></span><span class="line"><span class="mxinfo  sgl" id="T4:U19"><span class="var type1" id="S8T4U29">qib_gyro</span> = <span class="mxinfo  sgl" id="T4:U21"><span class="fcn" id="F176N6:B31">q_gyro</span>(<span class="var type1 sgl" id="S6T2U32">gyr_b</span>, <span class="mxinfo  sgl" id="T4:U23"><span class="var type1 sgl" id="S2T1U34">s</span>.qib_prev</span>, <span class="mxinfo  sgl" id="T3:U25"><span class="var type1 sgl" id="S2T1U37">s</span>.dt</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="49,11" id="srcline11">11</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="49,12" id="srcline12">12</a></span><span class="line"><span class="comment">% Racunam optimalni kvaternon iz acc i mag pomocu gradient descenta</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,13" id="srcline13">13</a></span><span class="line"><span class="comment">% Za inicijalni kvaternion koristim onaj izracunat iz ziroskopa</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,14" id="srcline14">14</a></span><span class="line">[<span class="var type1 sgl" id="S10T4U42">qib_gd</span>, <span class="mxinfo " id="T3:U28">~</span>] = <span class="fcn" id="F286N5:B45">q_gd</span>(<span class="var type1 sgl" id="S4T2U46">acc_b</span>, <span class="var type1 sgl" id="S5T2U47">mag_b</span>, <span class="mxinfo  sgl" id="T2:U31"><span class="var type1 sgl" id="S2T1U49">s</span>.acc_i</span>, <span class="mxinfo  sgl" id="T2:U33"><span class="var type1 sgl" id="S2T1U52">s</span>.mag_i</span>, <span class="var type1" id="S8T4U54">qib_gyro</span>, <span class="mxinfo  sgl" id="T3:U36"><span class="var type1 sgl" id="S2T1U56">s</span>.alpha</span>, <span class="mxinfo  sgl" id="T3:U38"><span class="var type1 sgl" id="S2T1U59">s</span>.N_max</span>, <span class="mxinfo  sgl" id="T3:U40"><span class="var type1 sgl" id="S2T1U62">s</span>.dJ_max</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="49,15" id="srcline15">15</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="49,16" id="srcline16">16</a></span><span class="line"><span class="comment">% Komplementarni filtar</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,17" id="srcline17">17</a></span><span class="line"><span class="mxinfo  sgl" id="T4:U42"><span class="var type1" id="S3T4U66">qib_est</span> = <span class="mxinfo  sgl" id="T4:U44"><span class="mxinfo  sgl" id="T4:U45"><span class="mxinfo  sgl" id="T3:U46"><span class="var type1 sgl" id="S2T1U70">s</span>.K_cf</span> * <span class="var type1 sgl" id="S8T4U72">qib_gyro</span></span> + <span class="mxinfo  sgl" id="T4:U49">(<span class="mxinfo  sgl" id="T3:U50">1 - <span class="mxinfo  sgl" id="T3:U51"><span class="var type1 sgl" id="S2T1U78">s</span>.K_cf</span></span>) * <span class="var type1" id="S10T4U80">qib_gd</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="49,18" id="srcline18">18</a></span><span class="line"><span class="mxinfo  sgl" id="T4:U54"><span class="var type1" id="S3T4U83">qib_est</span> = <span class="mxinfo  sgl" id="T4:U56"><span class="var type1 sgl" id="S3T4U85">qib_est</span> / <span class="mxinfo  sgl" id="T3:U58">norm(<span class="var type1 sgl" id="S3T4U88">qib_est</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="49,19" id="srcline19">19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="49,20" id="srcline20">20</a></span><span class="line"><span class="comment">% Storing current quaternion for the next iterative process</span></span></span>
<span class="srcline"><span class="lineno"><a href="49,21" id="srcline21">21</a></span><span class="line"><span class="mxinfo  sgl" id="T4:U60"><span class="mxinfo  sgl" id="T4:U61"><span class="var type1 sgl" id="S2T1U92">s</span>.qib_prev</span> = <span class="var type1" id="S3T4U94">qib_est</span></span>; </span></span>
<span class="srcline"><span class="lineno"><a href="49,22" id="srcline22">22</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="49,23" id="srcline23">23</a></span><span class="line"><span class="keyword">end</span></span></span>
</pre>
